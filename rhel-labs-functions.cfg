#!/bin/bash

### logger function
__syslog() {
	logger -t $(basename $0) -p user.err "$@";
}

### cleanup function for open yet (deleted) filename inode pointers I've noticed, possibly self-inflicted here for future use

__clean() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
deleted="lsof |grep rhel-labs|grep "deleted"|awk '{print $2}'|wc -l"
delete="lsof |grep rhel-labs|grep "deleted"|awk '{print $2}'|xargs kill -9"
if [[ "$deleted" -gt "0" ]]; then
	$delete
	return 0
else
	return 0
fi
}



### download function
__labdownload() {
	exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
	percentage="0"
	DIALOG=${DIALOG=dialog}
	export HOME=/home/root/rhel-labs/.install
	xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.wget$$
	loc="http://irondung.net:8120/training/RHEL7.2-HOMELAB.tar.gz"
	trap "rm -f $xx" 0 1 2 5 15
	cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" | __syslog
	proc=$(ps auxx | grep -v grep | grep -e "wget")
	size=`ls -li|grep -e "RHEL7.2-HOMELAB.tar.gz$"|awk '{print $6}'`

	if [[ -f $HOME/.md5pass ]]; then
        	percentage="100"
		echo "conditional check finds .md5pass" | __syslog
	elif [[ "$size" == "543045073" ]]; then
		percentage="100"
		echo "conditional check finds size" | __syslog
	else
        	wget -c -b "$loc" -o "$xx" || echo "Failed to start wget" | __syslog
	fi

	(while (true)
	do  
	    exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
	    proc=$(ps auxx | grep -v grep | grep -e "wget")
	    if [[ "$proc" == "" ]] && [[ "$percentage"="100" ]]; then
	    echo 100
 	    sleep 2
	    return 0 && echo "archive is present or finished downloading, moving on" | __syslog
	    echo "conditional check finds download while loop is complete" | __syslog
	    fi
	    percentage="0"
	    sleep 1
	    percentage=$(tail -n2 $xx |grep -o [0-9][0-9]% |grep -o [0-9][0-9] || tail -n2 $xx | grep -o [0-9]% | grep -o [0-9] || tail -n2 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || tail -n5 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || echo "failed to parse wget check clone function percentage loop syntax" | __syslog; return 0)
	    static=$percentage
	    sleep 1
	    echo $static
    	    done
	    ) | 
	    $DIALOG --title "Downloading Archive:" \
		    --gauge " \n
	    	RHEL7.2-HOMELAB.tar.gz (518M) >> (1.3G) \n
	    " 10 70 0 || ps auxx | grep -v grep | egrep -i "wget|clone"|awk '{print $2}'|xargs kill -9 || echo "Failed to start clone, check functions" | __syslog
}

__labmd5() {
	exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
	percentage="0"
	DIALOG=${DIALOG=dialog}
	export HOME=/home/root/rhel-labs/.install
	xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.wgetmd5$$
	trap "rm -f $xx" 0 1 2 5 15
	loc="http://irondung.net:8120/training/RHEL7.2-HOMELAB.tar.gz_md5sum"			    
	cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function"
	proc=$(ps auxx | grep -v grep | grep -e "wget")
if [[ "$proc" == "" ]] && [[ -f $HOME/.md5pass ]] && [[ -f $HOME/.install-finished ]]; then
	percentage="100"
elif [[ ! -f $HOME/RHEL7.2-HOMELAB.tar.gz_md5sum ]] && [[ ! -f $HOME/.md5pass ]]; then

	wget -c -b "$loc" -o "$xx" || echo "Failed to start wget" | __syslog
fi
	(while (true)
	do		
	exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
	proc=$(ps auxx | grep -v grep | grep -e "wget")
        if [[ "$proc" == "" ]] && [[ "$percentage"="100" ]]; then
		echo 100
		sleep 2
		return 0 && echo "md5sum check for archive is present or finished downloading, moving on" | __syslog
	fi
	percentage="0"
	sleep 1
	percentage=$(tail -n2 $xx |grep -o [0-9][0-9]% |grep -o [0-9][0-9] || tail -n2 $xx | grep -o [0-9]% | grep -o [0-9] || tail -n2 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || tail -n5 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || echo "failed to parse wget check clone function percentage loop syntax" | __syslog; return 0)
	static=$percentage
	sleep 1
	echo $static
	done
	)|
	$DIALOG --title "Downloading Checksum:" \
		--gauge " \n
		RHEL7.2-HOMELAB.tar.gz_md5sum \n
		" 10 70 0 || ps auxx | grep -v grep | egrep -i "wget|md5|tar" |awk '{print $2}'|xargs kill -9 || echo "Failed to start clone, check functions" | __syslog

		md5check=`touch md5sum_post && md5sum RHEL7.2-HOMELAB.tar.gz > md5sum_post`
		sleep 2
		md51=`cat md5sum_post |awk '{print $1}'`
		md52=`cat RHEL7.2-HOMELAB.tar.gz_md5sum |awk '{print $1}'`

        if [[ "$md51"="$md52" ]] && [[ ! -f $HOME/.md5pass ]];then
		touch $HOME/.md5pass
		echo "created .md5pass" | __syslog
		return 0
	elif [[ "$md51"="$md52" ]] && [[ -f $HOME/.md5pass ]];then
		echo ".md5pass found" | __syslog
		return 0
	else
		echo "md5sum check function failed to return 0 properly" | __syslog && return 0
	fi
	}

__tarf() {
		exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
		export HOME=/home/root/rhel-labs/.install
		xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.tarmd5$$
		trap "rm -f $xx" 0 1 2 5 15
		unpack="tar xvf RHEL7.2-HOMELAB.tar.gz"
		
		cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" | __syslog
		#unpackp="% tar cvf - RHEL7.2-HOMELAB.tar.gz | pv -p -s ${SIZE}k"

		md5check=`touch md5sum_post && md5sum RHEL7.2-HOMELAB.tar.gz > md5sum_post`
		sleep 2
		md51=`cat md5sum_post |awk '{print $1}'`
		echo $md51 | __syslog
		md52=`cat RHEL7.2-HOMELAB.tar.gz_md5sum |awk '{print $1}'`
		echo $md52 | __syslog

	if [[ "$md51"="$md52" ]] && [[ ! -f $HOME/.install-finished ]] && [[ -f $HOME/.md5pass ]]; then
		percentage="0"
		DIALOG=${DIALOG=dialog}
		export HOME=/home/root/rhel-labs/.install
		xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.tar$$
		trap "rm -f $xx" 0 1 2 5 15
		mkdir -p /home/root/rhel-labs/.storage && chown qemu:qemu -R /home/root/rhel-labs/.storage || echo "failed to create install dir" | __syslog
		cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" | __syslog
		
	fi
		(pv -L 5m -n RHEL7.2-HOMELAB.tar.gz | tar xzf - -C /home/root/rhel-labs/.storage/ ) 2>&1 | dialog --gauge " Extracting RHEL7.2-HOMELAB.tar.gz" 6 50 || ps auxx | grep -v grep | egrep -i "pv|tar" |awk '{print $2}'|xargs kill -9 || echo "failed to run tar function, check functions" | __syslog
		touch $HOME/.install-finished
		echo ".install-finished created" | __syslog
		return 0
}


__servermd5() {
	exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
        percentage="0"
        DIALOG=${DIALOG=dialog}
        export HOME=/home/root/rhel-labs/.storage
        xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.wgetmd5server$$
        trap "rm -f $xx" 0 1 2 5 15
        loc="http://irondung.net:8120/training/.server.example.com_md5sum"
        cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" | __syslog
        proc=$(ps auxx | grep -v grep |grep lab|grep -e "wget")
if [[ "$proc" == "" ]] && [[ -f $HOME/.md5pass-server ]]; then
        percentage="100"
	echo ".md5pass-server created" | __syslog
elif [[ ! -f $HOME/.server.example.com_md5sum ]] && [[ ! -f $HOME/.md5pass-server ]]; then
	wget -c -b "$loc" -o "$xx" || echo "Failed to start wget" | __syslog
fi

        (while (true)
        do
        exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
        proc=$(ps auxx | grep -v grep | grep -e "wget")
        if [[ "$proc" == "" ]] && [[ "$percentage"="100" ]]; then
                echo 100
                sleep 2
                return 0
        fi
        percentage="0"
        sleep 1
        percentage=$(tail -n2 $xx |grep -o [0-9][0-9]% |grep -o [0-9][0-9] || tail -n2 $xx | grep -o [0-9]% | grep -o [0-9] || tail -n2 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || tail -n5 $xx | grep -o [0-9][0-9][0-9]% | grep -o [0-9][0-9][0-9] || echo "failed to parse wget check clone function percentage loop syntax for server.example.com md5sum check"; return 0)
        static=$percentage
        sleep 1
        echo $static
        done
        )|
        $DIALOG --title "Downloading Checksum:" \
                --gauge " \n
                .server.example.com_md5sum \n
                " 10 70 0 || ps auxx | grep -v grep | egrep -i "wget|md5" |awk '{print $2}'|xargs kill -9 || echo "Failed to md5 check for server.example.com, check functions" | __syslog

                md5check=`touch .server.example.com_md5sum_post && md5sum server.qcow > .server.example.com_md5sum_post`
                sleep 2
                md51=`cat .server.example.com_md5sum_post |awk '{print $1}'`
                md52=`cat .server.example.com_md5sum |awk '{print $1}'`

        if [[ "$md51"="$md52" ]] && [[ ! -f $HOME/.md5pass-server ]];then
                touch $HOME/.md5pass-server
		echo "creating .md5pass-server" | __syslog
                return 0
        elif [[ "$md51"="$md52" ]] && [[ -f $HOME/.md5pass-server ]];then
                echo "all conditions successful" | __syslog
		return 0
        else
                echo "server.example.com md5sum check function failed to return 0 properly" | __syslog && return 0
        fi
        }

__server_install() {
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15
mac=$(tr -dc A-F0-9 < /dev/urandom | head -c 10 | sed -r 's/(..)/\1:/g;s/:$//;s/^/02:/')
virt-install \
 --connect qemu:///system \
 --virt-type kvm \
 --name server.example.com \
 --cpu host \
 --vcpu 2 \
 --ram 1024 \
 --os-type=linux \
 --os-variant=rhel7 \
 --disk path=/home/root/rhel-labs/.storage/server.example.com.qcow,bus=virtio \
 --network network=rhel-labs,mac=$mac \
 --graphics spice \
 --force \
 --import &> >(__syslog)
sleep 5
check=`virsh list --all|grep -o server.example.com|wc -l`
if [ "$check" == "1" ]; then
	touch $HOME/.server-installed && echo ".server-installed created" | __syslog && return 0
fi
}

__servervirtinstall() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15
#netcheck=$(virsh net-list|grep rhel-labs|awk '{print $1}'| wc -l)
virtcheck=$(virsh list --all|grep -o server.example.com|wc -l)
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
vmpwdown="virsh destroy server.example.com"
vmdelete="virsh undefine server.example.com"
#stordelete="virsh pool-define /home/root/rhel-labs/.storage/server.example.qcow"
#netdelete=$(rm -f /usr/share/libvirt/networks/rhel-labs.xml && virsh net-destroy rhel-labs && touch $HOME/.virsh-network-removed )
#rmstates=$(rm -f $HOME/{.virsh-network-removed,.virsh-virts-removed})
cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" | __syslog

if [[ "$virshcheck"="1" ]]; then
	$vmpwdown ; $vmdelete ; $stordelete || echo "Failed to destroy server.example.com" | __syslog
	echo "virsh preped for vm creation" | __syslog
	systemctl start libvirtd || echo "Failed to start libvirtd" | __syslog
	systemctl enable libvirtd || echo "Failed to enable libvirtd" | __syslog
fi

(while (true)
do
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.serverreboot_while$$
trap "rm -f $xx" 0 1 2 5 15
proc="ps auxx|grep -v grep|grep virt-viewer|grep -o server.example.com|wc -l"
virtcheck=$(virsh list --all|grep -o server.example.com|wc -l)
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)

if [[ "percentage"="100" ]] && [[ "$virshcheck" == "1" ]]; then
sleep 2
echo 98
sleep 1
echo 99
sleep 1
echo 100
sleep 1
return 0
percentage="0"
elif [[ "$virtcheck"="0" ]] && [[ "$virshcheck"="1" ]]; then
percentage="100"	
return 0
fi
sleep 1
echo $percentage
percentage=$(expr $percentage + 1)
done )|
     $DIALOG --title "Creating VM" \
	     --gauge " \n
             		virt-install: server.example.com \n
	     " 10 70 0 || ps auxx|grep -v grep|grep -v vim|grep "lab"|grep server_3 |awk '{print $2}'|xargs kill -9 && return 0 || echo "virt-install while loop failed" | __syslog && return 0

}


__serverreboot() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15

cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function"
percentage="0"

(while (true)
do
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.servervirt_while$$
trap "rm -f $xx" 0 1 2 5 15
proc="ps auxx|grep -v grep|grep virt-viewer|grep -o server.example.com|wc -l"
virtcheck=$(virsh list --all|grep server.example.com|awk '{print $3}'|grep "running"| wc -l)
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
reboot=`virsh --connect qemu:///system reboot server.example.com &> >(__syslog)`

if [[ "$virtcheck" == "0" ]]; then
echo 100
sleep 1
return 0


elif [[ "$virtcheck"="1" ]] && [[ "$virshcheck"="1" ]]; then
percentage="100"
$reboot 2>/dev/null
echo $percentage
sleep 2
return 0
fi
echo $percentage
percentage=$(expr $percentage + 1)
done )|
     $DIALOG --title "server.example.com" \
             --gauge " \n
              		Rebooting.. \n
             " 10 70 0 || ps auxx|grep -v grep|grep -v vim|grep "lab"|grep server_3 |awk '{print $2}'|xargs kill -9 || echo "virsh reboot  while loop failed"
}


__serverstop() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15


cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function"
percentage="0"

(while (true)
do
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.servervirt_while$$
trap "rm -f $xx" 0 1 2 5 15
proc="ps auxx|grep -v grep|grep virt-viewer|grep -o server.example.com|wc -l"
virtcheck="virsh list --all|grep server.example.com|awk '{print $3}'|grep "running"|wc -l"
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
virtstop=`virsh --connect qemu:///system destroy server.example.com &> >(__syslog)`

if [[ "$virtcheck" == "0" ]]; then
percentage="100"
sleep 1
echo $percentage
return 0

elif [[ "$virtcheck"="1" ]]; then
percentage="100"
$virtstop && sleep 1 || sleep 1

sleep 2
echo $percentage
return 0
fi
percentage=$(expr $percentage + 1)
done )|
     $DIALOG --title "server.example.com" \
             --gauge " \n
              		Stopping.. \n
             " 10 70 0 || ps auxx|grep -v grep|grep -v vim|grep "lab"|grep _serverreboot |awk '{print $2}'|xargs kill -9 && return 0 || echo "virsh reboot  while loop failed"
return 0
}

__serverstart() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15

cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function"
percentage="0"

### start ### resolves https://github.com/vidurous/rhel-labs/issues/15
virtcheck=`virsh list --all|grep server.example.com|awk '{print $3}'|grep "running"|wc -l`
virshcheck=`systemctl status libvirtd|grep -o "active (running)"|wc -l`
netcheck=`virsh net-list --all|grep rhel-labs|wc -l`

if [[ "$netcheck" -lt "1" ]] && [[ "$virshcheck" -gt "0" ]] && [[ "$virtcheck" == "0" ]]; then
        echo "virsh network domain rhel-labs not found creating" | __syslog
        __servernetwork && sleep 1 | __syslog

elif [[ "$netcheck" -lt "1" ]] && [[ "$virshcheck" == "0" ]] && [[ "$virtcheck" == "0" ]]; then
	echo "virsh network domain rhel-labs and libvirtd not running, fixing both issues" | __syslog
	systemctl start libvirtd && __servernetwork && sleep 1 | __syslog
fi       
### finish ### resolves https://github.com/vidurous/rhel-labs/issues/15

(while (true)
do
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.servervirt_while$$
trap "rm -f $xx" 0 1 2 5 15
#proc="ps auxx|grep -v grep|grep virt-viewer|grep -o server.example.com|wc -l"
virtcheck="virsh list --all|grep server.example.com|awk '{print $3}'|grep "running"|wc -l"
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
virtstart=`virsh --connect qemu:///system start server.example.com &> >(__syslog)`

if [[ "$virtcheck" == "1" ]]; then
percentage="100"
sleep 1
echo $percentage
return 0

elif [[ "$virtcheck"="1" ]] && [[ "$virshcheck"="1" ]]; then
percentage="100"
$virtstart && sleep 1 || sleep 1
echo $percentage
sleep 2
return 0
fi
percentage=$(expr $percentage + 1)
done )|
      $DIALOG --title "server.example.com" \
             --gauge " \n
                      Starting.. \n
		      " 10 70 0 || ps auxx|grep -v grep|grep -v vim|grep "lab"|grep __serverstart |awk '{print $2}'|xargs kill -9 && return 0 || echo "virt-viewer while loop failed"

}

__serverconsole() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.virt-install$$
trap "rm -f $xx" 0 1 2 5 15

cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function"
percentage="0"

(while (true)
do
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.storage
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.storage/.servervirt_while$$
trap "rm -f $xx" 0 1 2 5 15
proc="ps auxx|grep -v grep|grep virt-viewer|grep -o server.example.com|wc -l"
virtcheck=$(ps auxx|grep -v grep|grep -v vim|grep virt-viewer|grep -o server.example.com|wc -l)
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
virtconsole=`virt-viewer --connect qemu:///system server.example.com &> >(__syslog)`

if [[ "$proc" == "1" ]]; then
echo "100"
return 0


elif [[ "$proc"="0" ]]; then
percentage="100"
echo $percentage
$virtconsole && sleep 1
echo $percentage
sleep 2
return 0
fi
percentage=$(expr $percentage + 1)
done )|
     $DIALOG --title "server.example.com" \
             --gauge " \n
                        Opening a console.. \n
             " 10 70 0 || ps auxx|grep -v grep|grep -v vim|grep virt-viewer|grep server.example.com|awk '{print $2}'|xargs kill -9 && return 0 || echo "virsh reboot  while loop failed"

}

__desktop_install() {
printf "Spawning RHEL7.2 training desktop vm."
desktop=desktop
mac=`tr -dc A-F0-9 < /dev/urandom | head -c 10 | sed -r 's/(..)/\1:/g;s/:$//;s/^/02:/'`
virt-install \
 --connect qemu:///system \
 --virt-type kvm \
 --name $desktop \
 --cpu host \
 --vcpu 2 \
 --ram 2048 \
 --os-type=linux \
 --os-variant=rhel7 \
 --disk path=/$HOME/training/$desktop.img,bus=virtio \
 --network network=default,mac=$mac \
 --graphics spice \
 --force \
 --import
}

__servernetwork() {
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.servernetwork$$
trap "rm -f $xx" 0 1 2 5 15
netcheck=$(virsh net-list|grep rhel-labs|awk '{print $1}'| wc -l)
virtcheck=$(virsh list --all|grep -o server.example.com|wc -l)
virshcheck=$(systemctl status libvirtd|grep -o "active (running)"|wc -l)
vmpwdown="virsh destroy server.example.com && virsh undefine server.example.com && touch $HOME/.virsh-virts-removed"
vmdelete="virsh undefine server.example.com && touch $HOME/.virsh-virts-removed"
netdelete="virsh net-destroy rhel-labs"
rmstates="rm -f $HOME/{.virsh-network-removed,.virsh-virts-removed}"
cd $HOME/ || mkdir -p $HOME && cd $HOME || echo "Failed to create $HOME, check clone function" 2>1 >> $xx

# this will blow away the current virsh network domain no matter what for setup reasons
echo "Setting up "rhel-labs" network domain." 2>1 >> $xx

if [[ "$netcheck"="0" ]]; then
$netdelete || echo "failed to destroy rhel-labs network" 2>1 >> $xx
fi


(while (true)
do
exec -a rhel-labs-functions 2> >(logger -s -t $(basename $0)) &
DIALOG=${DIALOG=dialog}
export HOME=/home/root/rhel-labs/.install
xx=`xx 2>/dev/null` || xx=/home/root/rhel-labs/.install/.servernetwork_while$$
trap "rm -f $xx" 0 1 2 5 15
proc=$(systemctl status libvirtd|grep -o "active (running)"| wc -l)
proc2=$(virsh net-list|grep rhel-labs|grep -o "active"| wc -l)

if [[ "$proc" == "0" ]]; then
       systemctl start libvirtd || echo "failed to start libvirtd"
       systemctl enable libvirtd || echo "failed to start libvirtd"
elif [[ "$proc" == "1" ]] && [[ "$proc2" == "1" ]]; then
# The process has finished. It is no longer running.
# So slowly count the percentage down to 100%.
sleep 2
echo 98
sleep 1
echo 99
sleep 1
echo 100
sleep 1
return 0

percentage="0"
elif [[ "$proc" == "1" ]] && [[ "$proc2" == "0" ]] && [[ "$percentage" -gt "0" ]]; then
echo "generating /usr/share/libvirt/networks/rhel-labs.xml." 2&>1 >> $xx
cat > /usr/share/libvirt/networks/rhel-labs.xml << EOF
<network>
  <name>rhel-labs</name>
  <forward mode='nat'/>
  <bridge name="rhel-labs"/>
  <forward/>
  <ip address="192.168.142.1" netmask="255.255.255.0">
    <dhcp>
      <range start="192.168.142.2" end="192.168.142.254"/>
    </dhcp>
  </ip>
</network>
EOF
echo "creating "rhel-labs" network with nat forwarding." 2&>1 >> $xx
virsh net-create /usr/share/libvirt/networks/rhel-labs.xml || echo "failed to create rhel-labs network domain"
fi

sleep 1
echo $percentage
percentage=$(expr $percentage + 1)
done
)|
$DIALOG --title "Creating Network Domain" \
	--gauge " \n
virsh network: rhel-labs \n
" 10 70 0 || ps auxx | grep -v grep |grep -v vim |egrep -i "lab" |awk '{print $2}'|xargs kill -9 || echo "Failed to create virsh network domain "rhel-labs" for server.example.com, check functions"
}

# MAIN
for args in "$@"; do
	if [ "$args" = "clone" ]; then
		__labdownload || echo "__labdownload function has failed" && exit
    	elif [ "$args" = "labmd5" ]; then
        	__labmd5 || echo "__labmd5 has failed" && exit
	elif [ "$args" = "tar" ]; then
		__tarf || echo "__tarf has failed" && exit
	elif [ "$args" = "server_1" ]; then
		__servermd5 || echo "__servermd5 has failed" && exit
	elif [ "$args" = "server_2" ]; then
		__servernetwork || echo "__servernetwork has failed" && exit
	elif [ "$args" = "server_3" ]; then
		__servervirtinstall && exit
	elif [ "$args" = "server_4" ]; then
		__server_install&exit
	elif [ "$args" = "__serverreboot" ]; then
		__serverreboot && exit || echo "failed to reboot server"
	elif [ "$args" = "__serverstop" ];then
		__serverstop && exit || echo "failed to stop server"
	elif [ "$args" = "__serverstart" ];then
		__serverstart && exit || echo "failed to start server"
	elif [ "$args" = "__serverconsole" ];then
        	__serverconsole&exit
	elif [ "$args" = "__syslog" ];then
		__syslog && exit
        elif [ "$args" = "__clean" ];then
                __clean && exit
	else

        echo "Main functions script has failed to return 0 properly" && exit

	fi
done
